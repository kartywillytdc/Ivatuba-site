<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presen√ßa - FitApp</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
</head>
<body class="dark-theme">
    <div class="main-content">
        <div class="container">
            <div class="page-header">
                <button class="btn btn-ghost" onclick="window.history.back()">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <div>
                    <h1>Marcar Presen√ßa</h1>
                    <p id="currentDate">Carregando...</p>
                </div>
            </div>

            <div class="attendance-card card">
                <div class="attendance-icon" id="attendanceIcon">
                    <span class="material-symbols-outlined">how_to_reg</span>
                </div>
                <h2 id="attendanceTitle">Marcar Presen√ßa</h2>
                <p id="attendanceMessage">Ganhe +20 foguinhos por vir treinar hoje!</p>
                
                <button class="btn btn-primary btn-block" id="attendanceBtn" onclick="markAttendance()">
                    Registrar Presen√ßa
                </button>
            </div>

            <div class="attendance-stats">
                <div class="stat-card">
                    <span class="material-symbols-outlined">calendar_month</span>
                    <div>
                        <h3 id="monthAttendance">0</h3>
                        <p>Este M√™s</p>
                    </div>
                </div>

                <div class="stat-card">
                    <span class="material-symbols-outlined">local_fire_department</span>
                    <div>
                        <h3 id="currentStreak">0</h3>
                        <p>Sequ√™ncia</p>
                    </div>
                </div>
            </div>

            <div class="calendar-view card">
                <h3>Hist√≥rico de Presen√ßa</h3>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calend√°rio ser√° gerado aqui -->
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="dashboard.html" class="bottom-nav-item">
            <span class="material-symbols-outlined">home</span>
            <span>In√≠cio</span>
        </a>
        <a href="workouts.html" class="bottom-nav-item">
            <span class="material-symbols-outlined">fitness_center</span>
            <span>Treinos</span>
        </a>
        <a href="store.html" class="bottom-nav-item">
            <span class="material-symbols-outlined">storefront</span>
            <span>Loja</span>
        </a>
        <a href="profile.html" class="bottom-nav-item">
            <span class="material-symbols-outlined">person</span>
            <span>Perfil</span>
        </a>
    </nav>

    <script type="module">
        import { checkAuth } from './js/auth.js';
        import { getUserData, updateUserData } from './js/database.js';

        let currentUser = null;
        let hasMarkedToday = false;

        checkAuth(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = user;
            initializePage();
        });

        async function initializePage() {
            // Data atual
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = today.toLocaleDateString('pt-BR', options);

            // Verificar se j√° marcou presen√ßa hoje
            const userData = await getUserData(currentUser.uid);
            if (userData.success) {
                const lastAttendance = userData.data.lastAttendance;
                const todayStr = today.toISOString().split('T')[0];

                if (lastAttendance === todayStr) {
                    hasMarkedToday = true;
                    showAlreadyMarked();
                }

                // Atualizar estat√≠sticas
                document.getElementById('currentStreak').textContent = userData.data.streak || 0;
                document.getElementById('monthAttendance').textContent = userData.data.monthAttendance || 0;
            }

            generateCalendar();
        }

        window.markAttendance = async function() {
            if (hasMarkedToday) {
                alert('Voc√™ j√° marcou presen√ßa hoje!');
                return;
            }

            const userData = await getUserData(currentUser.uid);
            if (userData.success) {
                const data = userData.data;
                const today = new Date().toISOString().split('T')[0];

                await updateUserData(currentUser.uid, {
                    foguinhos: (data.foguinhos || 0) + 20,
                    lastAttendance: today,
                    streak: (data.streak || 0) + 1,
                    monthAttendance: (data.monthAttendance || 0) + 1
                });

                hasMarkedToday = true;
                showSuccess();
            }
        }

        function showSuccess() {
            document.getElementById('attendanceIcon').innerHTML = '<span class="material-symbols-outlined" style="color: var(--primary);">check_circle</span>';
            document.getElementById('attendanceTitle').textContent = 'Presen√ßa Registrada!';
            document.getElementById('attendanceMessage').textContent = 'Voc√™ ganhou +20 foguinhos! üî•';
            document.getElementById('attendanceBtn').disabled = true;
            document.getElementById('attendanceBtn').textContent = 'Presen√ßa Marcada';
            document.getElementById('attendanceBtn').classList.add('btn-disabled');
        }

        function showAlreadyMarked() {
            document.getElementById('attendanceIcon').innerHTML = '<span class="material-symbols-outlined" style="color: var(--primary);">check_circle</span>';
            document.getElementById('attendanceTitle').textContent = 'Presen√ßa j√° marcada';
            document.getElementById('attendanceMessage').textContent = 'Voc√™ j√° registrou sua presen√ßa hoje!';
            document.getElementById('attendanceBtn').disabled = true;
            document.getElementById('attendanceBtn').textContent = 'J√° Marcado';
            document.getElementById('attendanceBtn').classList.add('btn-disabled');
        }

        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            let html = '<div class="calendar-header">';
            ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'].forEach(day => {
                html += `<div class="calendar-day-name">${day}</div>`;
            });
            html += '</div><div class="calendar-days">';

            // Dias vazios antes do primeiro dia
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // Dias do m√™s
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === today.getDate();
                const isPast = day < today.getDate();
                const marked = Math.random() > 0.5 && isPast; // Simula√ß√£o

                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${marked ? 'marked' : ''}">
                        ${day}
                        ${marked ? '<span class="check-mark">‚úì</span>' : ''}
                    </div>
                `;
            }

            html += '</div>';
            grid.innerHTML = html;
        }
    </script>
</body>
</html>
